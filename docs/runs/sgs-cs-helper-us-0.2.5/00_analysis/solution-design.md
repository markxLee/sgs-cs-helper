# Solution Design: US-0.2.5 ‚Äî Staff Code Login (REVISED)
<!-- Generated: 2026-02-06 | Product: sgs-cs-helper | Revision: 3 -->

---

## üìù Revision Notes

**Original understanding:** Anonymous shared code for all staff
**Updated understanding (Rev 2):** Per-user staff code with individual permissions
**Updated understanding (Rev 3):** Added system-wide login mode configuration

**Key Changes:**
- Staff code is per-user (stored in User.staffCode)
- Each staff has individual User record
- Permissions: canUpload, canUpdateStatus
- Admin/Super Admin manage staff users and permissions
- **NEW:** System-wide login mode setting (quick_code, full_login, both)
- **NEW:** Staff code must be unique (enforced by schema)
- **NEW:** Login form adapts based on login mode config

---

## 0.1 Request Analysis / Ph√¢n t√≠ch Y√™u c·∫ßu

### Problem Statement / V·∫•n ƒë·ªÅ

**EN:** Staff members need a quick login method using a personal code. Each staff user has their own code (stored in User.staffCode). Admin/Super Admin manage staff users and control their permissions (upload orders, update status).

**VI:** Nh√¢n vi√™n c·∫ßn ph∆∞∆°ng th·ª©c ƒëƒÉng nh·∫≠p nhanh b·∫±ng m√£ c√° nh√¢n. M·ªói user nh√¢n vi√™n c√≥ m√£ ri√™ng (l∆∞u trong User.staffCode). Admin/Super Admin qu·∫£n l√Ω user nh√¢n vi√™n v√† ki·ªÉm so√°t quy·ªÅn (upload ƒë∆°n h√†ng, c·∫≠p nh·∫≠t tr·∫°ng th√°i).

### Context / Ng·ªØ c·∫£nh

| Aspect | Current / Hi·ªán t·∫°i | Desired / Mong mu·ªën |
|--------|-------------------|---------------------|
| Staff Authentication | Not implemented | Per-user code login |
| Staff User Records | Not created | Individual staff users with permissions |
| Permission Control | Only role-based | Role + specific permissions (canUpload, canUpdateStatus) |
| User Management | Super Admin only | Super Admin + Admin can manage staff |

### Gap Analysis / Ph√¢n t√≠ch Kho·∫£ng c√°ch

| Gap | Description |
|-----|-------------|
| Staff code auth | Need credentials provider for staffCode field |
| Permission fields | Need to add `canUpload`, `canUpdateStatus` to User model |
| Unique staff code | Make User.staffCode unique for authentication |
| Session permissions | Include permissions in JWT for access control |

### Affected Areas / V√πng ·∫¢nh h∆∞·ªüng

| Root | Component | Impact |
|------|-----------|--------|
| sgs-cs-helper | Prisma Schema | Add permission fields, make staffCode unique |
| sgs-cs-helper | Login Form | Add code input option with login type selection |
| sgs-cs-helper | Auth Config | Add staff code credentials provider |
| sgs-cs-helper | Session/JWT | Include permissions in JWT token |
| sgs-cs-helper | Type Definitions | Update next-auth.d.ts with permissions |

### Key Clarifications / L√†m r√µ Quan tr·ªçng

| Question | Answer |
|----------|--------|
| Staff code unique per user? | ‚úÖ Yes - stored in User.staffCode |
| Staff users have individual records? | ‚úÖ Yes - full User record with permissions |
| Who creates staff? | Admin and Super Admin |
| What permissions exist? | `canUpload` (upload orders), `canUpdateStatus` (mark done) |

### Assumptions / Gi·∫£ ƒë·ªãnh

1. **EN:** Each staff user has a unique code generated by Admin/Super Admin / **VI:** M·ªói nh√¢n vi√™n c√≥ m√£ duy nh·∫•t do Admin/Super Admin t·∫°o
2. **EN:** Staff code is 6-8 alphanumeric characters / **VI:** M√£ nh√¢n vi√™n l√† 6-8 k√Ω t·ª± ch·ªØ v√† s·ªë
3. **EN:** Staff permissions default to: canUpload=true, canUpdateStatus=true / **VI:** Quy·ªÅn m·∫∑c ƒë·ªãnh: canUpload=true, canUpdateStatus=true
4. **EN:** Staff users must have ACTIVE status to login / **VI:** Nh√¢n vi√™n ph·∫£i c√≥ tr·∫°ng th√°i ACTIVE ƒë·ªÉ ƒëƒÉng nh·∫≠p

---

## 0.2 Solution Research / Nghi√™n c·ª©u Gi·∫£i ph√°p

### Existing Patterns Found / Pattern C√≥ s·∫µn

| Location | Pattern | Applicable | Notes |
|----------|---------|------------|-------|
| `src/lib/auth/config.ts` | Credentials provider for Super Admin | Yes | Add second provider for staffCode |
| `prisma/schema.prisma` | User.staffCode field | Yes | Already exists, make unique |
| `src/app/(auth)/login/_components/login-form.tsx` | Client-side form with validation | Yes | Extend for code input |

### Schema Changes Needed / Thay ƒë·ªïi Schema C·∫ßn thi·∫øt

```prisma
model User {
  // Existing fields...
  
  // CHANGES:
  staffCode       String?  @unique    // Add @unique constraint
  
  // NEW FIELDS:
  canUpload       Boolean  @default(true)
  canUpdateStatus Boolean  @default(true)
}
```

### Dependencies / Ph·ª• thu·ªôc

| Dependency | Purpose | Status |
|------------|---------|--------|
| `next-auth` | Authentication framework | Existing |
| `@prisma/client` | Database queries | Existing |
| `crypto` | Generate unique codes | Built-in Node.js |

### Cross-Root Dependencies / Ph·ª• thu·ªôc ƒêa Root

None - single root implementation.

### Reusable Components / Component T√°i s·ª≠ d·ª•ng

- `src/lib/auth/config.ts` - Auth configuration pattern
- `src/lib/auth/password.ts` - Password utilities pattern

### New Components Needed / Component C·∫ßn t·∫°o M·ªõi

- Schema migration: Add permissions, make staffCode unique
- Staff code credentials provider in auth config
- Code input field in login form
- Session type extensions with permissions
- Staff code generator utility

---

## 0.3 Solution Design / Thi·∫øt k·∫ø Gi·∫£i ph√°p

### Solution Overview / T·ªïng quan Gi·∫£i ph√°p

**EN:** 
1. Add permission fields (`canUpload`, `canUpdateStatus`) to User model
2. Make `staffCode` unique for per-user authentication
3. Add staff code credentials provider to NextAuth
4. Update login form with code input option
5. Include permissions in JWT session for access control

**VI:**
1. Th√™m c√°c tr∆∞·ªùng quy·ªÅn (`canUpload`, `canUpdateStatus`) v√†o model User
2. L√†m `staffCode` unique ƒë·ªÉ x√°c th·ª±c theo user
3. Th√™m staff code credentials provider v√†o NextAuth
4. C·∫≠p nh·∫≠t form ƒëƒÉng nh·∫≠p v·ªõi t√πy ch·ªçn nh·∫≠p m√£
5. Bao g·ªìm quy·ªÅn trong JWT session ƒë·ªÉ ki·ªÉm so√°t truy c·∫≠p

### Approach Comparison / So s√°nh Ph∆∞∆°ng ph√°p

| Approach | Pros | Cons | Verdict |
|----------|------|------|---------|
| **Per-user code + permissions** | Individual control, audit trail, traceable | Slightly more complex | ‚úÖ Selected |
| Shared code + anonymous | Simple | No tracking, no permissions | ‚ùå Rejected: doesn't meet requirements |
| Permission groups/roles | Flexible | Over-engineered for 2 permissions | ‚ùå Rejected: overkill |

### Components / C√°c Component

| # | Name | Root | Purpose |
|---|------|------|---------|
| 1 | Schema Migration | sgs-cs-helper | Add permissions fields, make staffCode unique |
| 2 | Staff Code Provider | sgs-cs-helper | NextAuth provider for staffCode authentication |
| 3 | Login Form Update | sgs-cs-helper | Add code input with login type selection |
| 4 | Session Extension | sgs-cs-helper | Include permissions in JWT token |
| 5 | Code Generator | sgs-cs-helper | Utility to generate unique staff codes |

### Component Details / Chi ti·∫øt Component

#### Component 1: Schema Migration

| Aspect | Detail |
|--------|--------|
| Location | `prisma/schema.prisma` |
| Changes | Add `canUpload`, `canUpdateStatus` booleans; add `@unique` to `staffCode` |
| Migration | `pnpm db:migrate` with name "add-staff-permissions" |

#### Component 2: Staff Code Provider

| Aspect | Detail |
|--------|--------|
| Location | `src/lib/auth/config.ts` |
| Purpose | Validate staffCode against User table, return user with permissions |
| Inputs | `code` (string) |
| Outputs | User object with role=STAFF + permissions, or null |

#### Component 3: Login Form Update

| Aspect | Detail |
|--------|--------|
| Location | `src/app/(auth)/login/_components/login-form.tsx` |
| Changes | Add radio buttons for login type, code input field |
| UX | "Admin/Super Admin" vs "Staff (Quick Code)" selection |

#### Component 4: Session Extension

| Aspect | Detail |
|--------|--------|
| Location | `src/lib/auth/config.ts` (callbacks) + `src/types/next-auth.d.ts` |
| Changes | Add `canUpload`, `canUpdateStatus` to JWT token and session |
| Type Safety | Extend NextAuth types |

#### Component 5: Code Generator

| Aspect | Detail |
|--------|--------|
| Location | `src/lib/auth/staff-code.ts` |
| Function | `generateStaffCode()` returns unique 6-char alphanumeric |
| Used By | Admin/Super Admin when creating staff users (future US) |

### Data Flow / Lu·ªìng D·ªØ li·ªáu

| Step | From | To | Data | Action |
|------|------|----|------|--------|
| 1 | User | Login Form | Select "Staff" login type | Show code input |
| 2 | User | Login Form | Enter personal code | Collect input |
| 3 | Login Form | NextAuth | `{ code: "ABC123" }` | Call signIn("staff-code") |
| 4 | NextAuth | Staff Provider | code | Query User by staffCode |
| 5 | Staff Provider | Database | Query | Find user with matching code |
| 6 | Staff Provider | NextAuth | User + permissions | Return for JWT |
| 7 | NextAuth | Client | JWT session | Store in cookie |
| 8 | Client | Dashboard | Session | Access with permissions |

### Error Handling / X·ª≠ l√Ω L·ªói

| Scenario | Handling | User Impact |
|----------|----------|-------------|
| Invalid code | Return null from provider | "Invalid code" message |
| User not found | Return null | "Invalid code" message |
| User status PENDING | Return null | "Account pending approval" message |
| User status REVOKED | Return null | "Account deactivated" message |
| Database error | Log + return null | "Authentication failed" message |

### Rollback Plan / K·∫ø ho·∫°ch Rollback

**EN:** Run reverse migration to remove permission fields. Revert auth config and login form changes.

**VI:** Ch·∫°y migration ng∆∞·ª£c ƒë·ªÉ x√≥a c√°c tr∆∞·ªùng quy·ªÅn. Ho√†n t√°c thay ƒë·ªïi auth config v√† login form.

---

## 0.4 Schema Changes Summary / T√≥m t·∫Øt Thay ƒë·ªïi Schema

```prisma
model User {
  // Existing fields...
  
  // CHANGES:
  staffCode       String?  @unique    // Add @unique constraint
  
  // NEW FIELDS:
  canUpload       Boolean  @default(true)
  canUpdateStatus Boolean  @default(true)
}
```

---

## 0.5 Session/JWT Structure / C·∫•u tr√∫c Session/JWT

```typescript
interface Session {
  user: {
    id: string;
    email?: string;
    name?: string;
    role: "SUPER_ADMIN" | "ADMIN" | "STAFF";
    status: "ACTIVE" | "PENDING" | "REVOKED";
    // NEW permissions
    canUpload: boolean;
    canUpdateStatus: boolean;
  }
}
```

---

## 0.6 Login Mode Configuration / C·∫•u h√¨nh Ch·∫ø ƒë·ªô ƒêƒÉng nh·∫≠p

### Config Table Entry / M·ª•c trong B·∫£ng Config

```typescript
// Config key-value
{
  key: "login_mode",
  value: "quick_code" | "full_login" | "both"
}
```

### Login Mode Behavior / H√†nh vi Ch·∫ø ƒë·ªô ƒêƒÉng nh·∫≠p

| Mode | Staff Login Options | Admin/SuperAdmin |
|------|---------------------|------------------|
| `quick_code` | Code input only | Email/password always |
| `full_login` | Email/password only | Email/password always |
| `both` | Choice: code OR email/password | Email/password always |

### Login Form Logic / Logic Form ƒêƒÉng nh·∫≠p

```typescript
// Pseudo-logic for login form
const loginMode = await getConfig("login_mode");

if (selectedRole === "staff") {
  if (loginMode === "quick_code") {
    showCodeInput();
  } else if (loginMode === "full_login") {
    showEmailPasswordForm();
  } else { // "both"
    showLoginMethodChoice();
  }
} else {
  showEmailPasswordForm(); // Admin/SuperAdmin always
}
```

### Default Value / Gi√° tr·ªã M·∫∑c ƒë·ªãnh

- Default login mode: `quick_code`
- Set during seed or first admin setup

---

## 0.7 Diagrams / S∆° ƒë·ªì

See diagrams in `00_analysis/diagrams/` folder.
