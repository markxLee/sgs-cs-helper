# Specification â€” Staff Code Login (Per-User with Permissions)
<!-- Version: 1.0 | Contract: v1.0 | Created: 2026-02-06 -->
<!-- ğŸ‡»ğŸ‡³ Vietnamese first, ğŸ‡¬ğŸ‡§ English follows -->

---

## TL;DR

| Aspect | Value |
|--------|-------|
| Feature | Staff Code Login (Per-User) |
| Phase 0 Analysis | [Solution Design](../00_analysis/solution-design.md) |
| Status | Draft |
| Functional Requirements | 8 |
| Non-Functional Requirements | 4 |
| Affected Roots | sgs-cs-helper |

---

## 1. Overview

ğŸ‡»ğŸ‡³ TÃ­nh nÄƒng nÃ y cho phÃ©p nhÃ¢n viÃªn Ä‘Äƒng nháº­p nhanh báº±ng mÃ£ cÃ¡ nhÃ¢n (staff code). Má»—i nhÃ¢n viÃªn cÃ³ mÃ£ riÃªng duy nháº¥t do Admin/Super Admin táº¡o. Há»‡ thá»‘ng kiá»ƒm tra quyá»n truy cáº­p cá»§a tá»«ng nhÃ¢n viÃªn (upload Ä‘Æ¡n hÃ ng, cáº­p nháº­t tráº¡ng thÃ¡i) vÃ  quáº£n lÃ½ cháº¿ Ä‘á»™ Ä‘Äƒng nháº­p toÃ n há»‡ thá»‘ng (quick code, full login, hoáº·c cáº£ hai).

ğŸ‡¬ğŸ‡§ This feature allows staff members to login quickly using their personal code (staff code). Each staff member has a unique code generated by Admin/Super Admin. The system verifies individual staff permissions (upload orders, update status) and manages system-wide login mode configuration (quick code, full login, or both).

### Reference

- **Phase 0 Analysis:** [solution-design.md](../00_analysis/solution-design.md)
- **User Story:** US-0.2.5
- **Related Stories:** US-0.2.7 (Staff Management), US-0.2.8 (Login Mode Config)

---

## 2. Goals & Non-Goals

### Goals

ğŸ‡»ğŸ‡³
1. **ÄÄƒng nháº­p nhanh:** NhÃ¢n viÃªn cÃ³ thá»ƒ Ä‘Äƒng nháº­p báº±ng mÃ£ cÃ¡ nhÃ¢n (khÃ´ng cáº§n email/password)
2. **Kiá»ƒm soÃ¡t quyá»n:** Má»—i nhÃ¢n viÃªn cÃ³ quyá»n riÃªng (canUpload, canUpdateStatus)
3. **Quáº£n lÃ½ linh hoáº¡t:** Admin/Super Admin quáº£n lÃ½ nhÃ¢n viÃªn vÃ  cáº¥u hÃ¬nh cháº¿ Ä‘á»™ login
4. **Báº£o máº­t:** MÃ£ unique, session cÃ¡ nhÃ¢n, khÃ´ng áº©n danh

ğŸ‡¬ğŸ‡§
1. **Quick login:** Staff can login with personal code (no email/password needed)
2. **Permission control:** Each staff has individual permissions (canUpload, canUpdateStatus)
3. **Flexible management:** Admin/Super Admin manage staff and login mode configuration
4. **Security:** Unique codes, individual sessions, not anonymous

### Non-Goals

ğŸ‡»ğŸ‡³
1. âŒ Táº¡o staff code tá»± Ä‘á»™ng cho user hiá»‡n táº¡i (Ä‘Ã£ cÃ³ trong cÆ¡ sá»Ÿ dá»¯ liá»‡u)
2. âŒ TÃ­ch há»£p SSO/OAuth cho staff (chá»‰ Admin/Super Admin)
3. âŒ Quáº£n lÃ½ multi-factor authentication (MFA)
4. âŒ Tá»± Ä‘á»™ng khÃ³a tÃ i khoáº£n sau nhiá»u láº§n Ä‘Äƒng nháº­p sai

ğŸ‡¬ğŸ‡§
1. âŒ Auto-generate staff codes for existing users (already in database)
2. âŒ SSO/OAuth integration for staff (only Admin/Super Admin)
3. âŒ Multi-factor authentication (MFA) management
4. âŒ Auto-lock accounts after failed login attempts

---

## 3. User Stories

### US-0.2.5: Staff Code Login (Per-User)

ğŸ‡»ğŸ‡³ LÃ  nhÃ¢n viÃªn, tÃ´i muá»‘n Ä‘Äƒng nháº­p báº±ng mÃ£ cÃ¡ nhÃ¢n Ä‘á»ƒ truy cáº­p nhanh há»‡ thá»‘ng. Má»—i nhÃ¢n viÃªn cÃ³ mÃ£ riÃªng Ä‘Æ°á»£c Admin/Super Admin cáº¥p.

ğŸ‡¬ğŸ‡§ As a Staff member, I want to login with my personal code so that I can quickly access the system. Each staff has their own unique code assigned by Admin/Super Admin.

### US-0.2.7: Staff User Management (Related)

ğŸ‡»ğŸ‡³ LÃ  Admin/Super Admin, tÃ´i muá»‘n táº¡o vÃ  quáº£n lÃ½ nhÃ¢n viÃªn Ä‘á»ƒ kiá»ƒm soÃ¡t ai cÃ³ quyá»n truy cáº­p vÃ  há» cÃ³ thá»ƒ lÃ m gÃ¬.

ğŸ‡¬ğŸ‡§ As Admin/Super Admin, I want to create and manage staff users so that I can control who has access and what they can do.

### US-0.2.8: Login Mode Configuration (Related)

ğŸ‡»ğŸ‡³ LÃ  Admin/Super Admin, tÃ´i muá»‘n cáº¥u hÃ¬nh cháº¿ Ä‘á»™ Ä‘Äƒng nháº­p toÃ n há»‡ thá»‘ng Ä‘á»ƒ kiá»ƒm soÃ¡t nhÃ¢n viÃªn dÃ¹ng quick code hay pháº£i Ä‘Äƒng nháº­p Ä‘áº§y Ä‘á»§.

ğŸ‡¬ğŸ‡§ As Admin/Super Admin, I want to configure system-wide login mode so that I can control whether staff use quick code or must use full login.

---

## 4. Requirements Matrix

| ID | Title | Priority | Type | Roots |
|----|-------|----------|------|-------|
| FR-001 | Staff Code Authentication | Must | Functional | sgs-cs-helper |
| FR-002 | Permission Fields | Must | Functional | sgs-cs-helper |
| FR-003 | Login Form with Code Input | Must | Functional | sgs-cs-helper |
| FR-004 | Session with Permissions | Must | Functional | sgs-cs-helper |
| FR-005 | Login Mode Configuration | Must | Functional | sgs-cs-helper |
| FR-006 | Dynamic Login UI | Must | Functional | sgs-cs-helper |
| FR-007 | Code Uniqueness Constraint | Must | Functional | sgs-cs-helper |
| FR-008 | User Status Validation | Must | Functional | sgs-cs-helper |
| NFR-001 | Authentication Performance | Must | Performance | sgs-cs-helper |
| NFR-002 | Code Security | Must | Security | sgs-cs-helper |
| NFR-003 | Session Security | Must | Security | sgs-cs-helper |
| NFR-004 | Type Safety | Should | Maintainability | sgs-cs-helper |

---

## 5. Functional Requirements

### FR-001: Staff Code Authentication

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Há»‡ thá»‘ng pháº£i xÃ¡c thá»±c nhÃ¢n viÃªn báº±ng staff code. Khi nhÃ¢n viÃªn nháº­p mÃ£, há»‡ thá»‘ng query User table (WHERE staffCode = <code> AND role = STAFF), kiá»ƒm tra tráº¡ng thÃ¡i, vÃ  táº¡o session náº¿u há»£p lá»‡.

ğŸ‡¬ğŸ‡§ The system must authenticate staff using staff code. When staff enters code, the system queries User table (WHERE staffCode = <code> AND role = STAFF), verifies status, and creates session if valid.

#### Acceptance Criteria

- [ ] AC1: NextAuth credentials provider "staff-code" exists in auth config
- [ ] AC2: Provider accepts `{ code: string }` as input
- [ ] AC3: Provider queries User table: `WHERE staffCode = ? AND role = 'STAFF'`
- [ ] AC4: Provider verifies user status is ACTIVE
- [ ] AC5: Valid code returns user object with id, role, permissions
- [ ] AC6: Invalid code returns null (shows "Invalid code" error)
- [ ] AC7: User with PENDING/REVOKED status returns null with appropriate message

---

### FR-002: Permission Fields

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ User model pháº£i cÃ³ hai trÆ°á»ng boolean Ä‘á»ƒ kiá»ƒm soÃ¡t quyá»n: `canUpload` (upload file Excel) vÃ  `canUpdateStatus` (Ä‘Ã¡nh dáº¥u Ä‘Æ¡n hÃ ng hoÃ n thÃ nh). GiÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  `true` cho cáº£ hai.

ğŸ‡¬ğŸ‡§ User model must have two boolean fields to control permissions: `canUpload` (upload Excel files) and `canUpdateStatus` (mark orders as done). Default value is `true` for both.

#### Acceptance Criteria

- [ ] AC1: Prisma schema has `canUpload Boolean @default(true)`
- [ ] AC2: Prisma schema has `canUpdateStatus Boolean @default(true)`
- [ ] AC3: Migration created and applied successfully
- [ ] AC4: Existing users get default values (true) after migration
- [ ] AC5: TypeScript types regenerated from schema
- [ ] AC6: Seed script updated to set permissions for test users

---

### FR-003: Login Form with Code Input

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Form Ä‘Äƒng nháº­p pháº£i há»— trá»£ nháº­p mÃ£ nhÃ¢n viÃªn. UI hiá»ƒn thá»‹ radio buttons Ä‘á»ƒ chá»n role (Admin/Super Admin vs Staff), vÃ  hiá»ƒn thá»‹ input phÃ¹ há»£p (email/password hoáº·c code) dá»±a trÃªn login_mode config.

ğŸ‡¬ğŸ‡§ Login form must support staff code input. UI shows radio buttons to select role (Admin/Super Admin vs Staff), and displays appropriate input (email/password or code) based on login_mode config.

#### Acceptance Criteria

- [ ] AC1: Radio button group for role selection: "Admin/Super Admin" | "Staff"
- [ ] AC2: When "Admin/Super Admin" selected: Show email/password fields always
- [ ] AC3: When "Staff" selected + login_mode = "quick_code": Show code input only
- [ ] AC4: When "Staff" selected + login_mode = "full_login": Show email/password only
- [ ] AC5: When "Staff" selected + login_mode = "both": Show toggle to choose code OR email/password
- [ ] AC6: Code input: Text field, placeholder "Enter your code", 6-8 chars
- [ ] AC7: Form validation: Code required if code input shown
- [ ] AC8: Error messages display clearly below input

---

### FR-004: Session with Permissions

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ JWT session pháº£i chá»©a permissions cá»§a user (canUpload, canUpdateStatus) Ä‘á»ƒ middleware vÃ  server actions cÃ³ thá»ƒ kiá»ƒm tra quyá»n. TypeScript types cho session pháº£i Ä‘Æ°á»£c extend.

ğŸ‡¬ğŸ‡§ JWT session must contain user permissions (canUpload, canUpdateStatus) so middleware and server actions can verify access. TypeScript types for session must be extended.

#### Acceptance Criteria

- [ ] AC1: NextAuth callbacks (jwt) include canUpload, canUpdateStatus
- [ ] AC2: NextAuth callbacks (session) expose permissions to client
- [ ] AC3: Type definition in `src/types/next-auth.d.ts` extends Session with permissions
- [ ] AC4: `useSession()` hook returns typed session with permissions
- [ ] AC5: Server-side `auth()` returns session with permissions
- [ ] AC6: Middleware can access session.user.canUpload and canUpdateStatus

---

### FR-005: Login Mode Configuration

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Config table pháº£i lÆ°u cáº¥u hÃ¬nh `login_mode` vá»›i giÃ¡ trá»‹: `quick_code`, `full_login`, hoáº·c `both`. GiÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  `quick_code`. Admin/Super Admin cÃ³ thá»ƒ thay Ä‘á»•i qua settings page.

ğŸ‡¬ğŸ‡§ Config table must store `login_mode` setting with values: `quick_code`, `full_login`, or `both`. Default value is `quick_code`. Admin/Super Admin can change via settings page.

#### Acceptance Criteria

- [ ] AC1: Config table has key `login_mode` with default value `quick_code`
- [ ] AC2: Seed script creates this config entry
- [ ] AC3: Server action `getLoginMode()` retrieves config value
- [ ] AC4: Server action `updateLoginMode(mode)` updates config (Admin/Super Admin only)
- [ ] AC5: Login form calls `getLoginMode()` on mount to determine UI
- [ ] AC6: Config change takes effect immediately (no restart needed)

---

### FR-006: Dynamic Login UI

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Giao diá»‡n Ä‘Äƒng nháº­p pháº£i thay Ä‘á»•i Ä‘á»™ng dá»±a trÃªn login_mode config. Khi mode thay Ä‘á»•i, form tá»± Ä‘á»™ng cáº­p nháº­t Ä‘á»ƒ hiá»ƒn thá»‹ input phÃ¹ há»£p.

ğŸ‡¬ğŸ‡§ Login UI must adapt dynamically based on login_mode config. When mode changes, form automatically updates to show appropriate inputs.

#### Acceptance Criteria

- [ ] AC1: Form fetches login_mode on component mount
- [ ] AC2: `quick_code` mode: Only code input for staff
- [ ] AC3: `full_login` mode: Only email/password for staff
- [ ] AC4: `both` mode: Toggle button to choose between code and email/password
- [ ] AC5: UI state updates immediately when mode changes (no page refresh)
- [ ] AC6: Loading state shown while fetching login_mode

---

### FR-007: Code Uniqueness Constraint

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Staff code pháº£i unique trong User table. Schema constraint Ä‘áº£m báº£o khÃ´ng cÃ³ mÃ£ trÃ¹ng láº·p. Khi táº¡o user má»›i, há»‡ thá»‘ng kiá»ƒm tra code Ä‘Ã£ tá»“n táº¡i hay chÆ°a.

ğŸ‡¬ğŸ‡§ Staff code must be unique in User table. Schema constraint ensures no duplicate codes. When creating new user, system checks if code already exists.

#### Acceptance Criteria

- [ ] AC1: Prisma schema: `staffCode String? @unique`
- [ ] AC2: Database index created on staffCode column
- [ ] AC3: Attempt to create user with duplicate code fails with clear error
- [ ] AC4: Error message: "Staff code already exists"
- [ ] AC5: Code generator retries if collision detected (rare edge case)

---

### FR-008: User Status Validation

| Aspect | Detail |
|--------|--------|
| Priority | Must |
| Affected Roots | sgs-cs-helper |

#### Description

ğŸ‡»ğŸ‡³ Chá»‰ user vá»›i status = ACTIVE má»›i cÃ³ thá»ƒ Ä‘Äƒng nháº­p. User vá»›i PENDING hoáº·c REVOKED khÃ´ng Ä‘Æ°á»£c phÃ©p truy cáº­p há»‡ thá»‘ng.

ğŸ‡¬ğŸ‡§ Only users with status = ACTIVE can login. Users with PENDING or REVOKED status are not allowed to access the system.

#### Acceptance Criteria

- [ ] AC1: Auth provider checks `user.status === 'ACTIVE'`
- [ ] AC2: PENDING status: Return null with message "Account pending approval"
- [ ] AC3: REVOKED status: Return null with message "Account deactivated"
- [ ] AC4: Error messages are user-friendly and translated (EN/VI)

---

## 6. Non-Functional Requirements

### NFR-001: Authentication Performance

| Aspect | Detail |
|--------|--------|
| Category | Performance |
| Metric | < 500ms for 95% of auth requests |
| Target | 95th percentile |

#### Description

ğŸ‡»ğŸ‡³ QuÃ¡ trÃ¬nh xÃ¡c thá»±c (tá»« khi nháº­p mÃ£ Ä‘áº¿n khi táº¡o session) pháº£i nhanh Ä‘á»ƒ tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng mÆ°á»£t mÃ . Database query pháº£i Ä‘Æ°á»£c optimize.

ğŸ‡¬ğŸ‡§ Authentication process (from code input to session creation) must be fast for smooth user experience. Database queries must be optimized.

**Acceptance:**
- [ ] AC1: staffCode indexed in database
- [ ] AC2: Auth response time < 500ms (95th percentile)
- [ ] AC3: No N+1 queries in auth flow

---

### NFR-002: Code Security

| Aspect | Detail |
|--------|--------|
| Category | Security |
| Metric | Unique, unguessable codes |

#### Description

ğŸ‡»ğŸ‡³ Staff code pháº£i Ä‘á»§ phá»©c táº¡p Ä‘á»ƒ khÃ´ng thá»ƒ Ä‘oÃ¡n. Sá»­ dá»¥ng crypto-safe random generator. Code length tá»‘i thiá»ƒu 6 kÃ½ tá»±.

ğŸ‡¬ğŸ‡§ Staff codes must be complex enough to prevent guessing. Use crypto-safe random generator. Minimum code length is 6 characters.

**Acceptance:**
- [ ] AC1: Code generated using `crypto.randomBytes()`
- [ ] AC2: Code format: 6-8 alphanumeric characters
- [ ] AC3: No sequential patterns (e.g., 123456)
- [ ] AC4: No profanity filter needed (alphanumeric only)

---

### NFR-003: Session Security

| Aspect | Detail |
|--------|--------|
| Category | Security |
| Metric | JWT signed & httpOnly cookie |

#### Description

ğŸ‡»ğŸ‡³ Session token pháº£i Ä‘Æ°á»£c báº£o máº­t báº±ng JWT signature vÃ  lÆ°u trong httpOnly cookie Ä‘á»ƒ trÃ¡nh XSS attacks.

ğŸ‡¬ğŸ‡§ Session token must be secured with JWT signature and stored in httpOnly cookie to prevent XSS attacks.

**Acceptance:**
- [ ] AC1: NextAuth JWT strategy with secret
- [ ] AC2: Cookie: httpOnly, secure (production), sameSite
- [ ] AC3: Session expires after 30 days (configurable)
- [ ] AC4: Refresh token rotation (NextAuth default)

---

### NFR-004: Type Safety

| Aspect | Detail |
|--------|--------|
| Category | Maintainability |
| Metric | Full TypeScript coverage |

#### Description

ğŸ‡»ğŸ‡³ Táº¥t cáº£ types liÃªn quan Ä‘áº¿n session, user, permissions pháº£i Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong TypeScript. KhÃ´ng cÃ³ `any` types.

ğŸ‡¬ğŸ‡§ All types related to session, user, permissions must be defined in TypeScript. No `any` types.

**Acceptance:**
- [ ] AC1: Session type extends DefaultSession with permissions
- [ ] AC2: User type includes canUpload, canUpdateStatus
- [ ] AC3: No TypeScript errors in auth flow
- [ ] AC4: IDE autocomplete works for session.user.canUpload

---

## 7. User Flow

### Staff Login Flow

| Step | Action | System Response | Next Step |
|------|--------|-----------------|-----------|
| 1 | User visits /login | Show login form with role selection | 2 |
| 2 | User selects "Staff" | Fetch login_mode config | 3 |
| 3 | System shows code input (if quick_code) | Display code input field | 4 |
| 4 | User enters staff code | Validate format (client) | 5 |
| 5 | User clicks "Login" | Call signIn("staff-code", { code }) | 6 |
| 6 | NextAuth queries User table | Find user by staffCode + STAFF role | 7 or Error |
| 7 | User found & ACTIVE | Create JWT session with permissions | Redirect to /dashboard |
| Error | Invalid code / status | Show error message | Stay on login page |

### Flow Diagram

```mermaid
flowchart TD
    A[User visits /login] --> B{Select Role}
    B -->|Admin/Super Admin| C[Show email/password]
    B -->|Staff| D[Fetch login_mode]
    D --> E{Login Mode?}
    E -->|quick_code| F[Show code input]
    E -->|full_login| G[Show email/password]
    E -->|both| H[Show toggle choice]
    F --> I[User enters code]
    G --> J[User enters email/password]
    H --> K{User choice}
    K -->|Code| I
    K -->|Email/Password| J
    I --> L[Submit: signIn staff-code]
    J --> M[Submit: signIn credentials]
    L --> N{Valid code?}
    N -->|Yes + ACTIVE| O[Create session]
    N -->|No| P[Show error]
    M --> Q{Valid credentials?}
    Q -->|Yes + ACTIVE| O
    Q -->|No| P
    O --> R[Redirect to /dashboard]
    P --> S[Stay on login page]
```

---

## 8. Data Models

### Prisma Schema Changes

```prisma
model User {
  id              String   @id @default(cuid())
  email           String?  @unique
  name            String?
  role            Role     @default(STAFF)
  authMethod      AuthMethod @default(PASSWORD)
  passwordHash    String?
  status          UserStatus @default(PENDING)
  
  // UPDATED: Add @unique constraint
  staffCode       String?  @unique
  
  // NEW: Permission fields
  canUpload       Boolean  @default(true)
  canUpdateStatus Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([staffCode])
}

model Config {
  id    String @id @default(cuid())
  key   String @unique
  value String
  
  @@index([key])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  STAFF
}

enum UserStatus {
  ACTIVE
  PENDING
  REVOKED
}

enum AuthMethod {
  PASSWORD
  GOOGLE_OAUTH
  STAFF_CODE
}
```

### TypeScript Session Type

```typescript
// src/types/next-auth.d.ts
import { DefaultSession } from "next-auth";

declare module "next-auth" {
  interface Session {
    user: {
      id: string;
      email?: string;
      name?: string;
      role: "SUPER_ADMIN" | "ADMIN" | "STAFF";
      status: "ACTIVE" | "PENDING" | "REVOKED";
      // NEW: Permissions
      canUpload: boolean;
      canUpdateStatus: boolean;
    } & DefaultSession["user"];
  }

  interface User {
    id: string;
    email?: string;
    name?: string;
    role: "SUPER_ADMIN" | "ADMIN" | "STAFF";
    status: "ACTIVE" | "PENDING" | "REVOKED";
    staffCode?: string;
    canUpload: boolean;
    canUpdateStatus: boolean;
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string;
    role: string;
    status: string;
    canUpload: boolean;
    canUpdateStatus: boolean;
  }
}
```

---

## 9. API Contracts

### Server Actions

#### getLoginMode()

```typescript
// src/lib/actions/config.ts
export async function getLoginMode(): Promise<
  "quick_code" | "full_login" | "both"
> {
  const config = await prisma.config.findUnique({
    where: { key: "login_mode" }
  });
  return (config?.value as any) || "quick_code";
}
```

#### updateLoginMode()

```typescript
export async function updateLoginMode(
  mode: "quick_code" | "full_login" | "both"
): Promise<{ success: boolean; error?: string }> {
  // Check user role: Admin or Super Admin only
  const session = await auth();
  if (!session || !["ADMIN", "SUPER_ADMIN"].includes(session.user.role)) {
    return { success: false, error: "Unauthorized" };
  }

  await prisma.config.upsert({
    where: { key: "login_mode" },
    update: { value: mode },
    create: { key: "login_mode", value: mode }
  });

  return { success: true };
}
```

### NextAuth Provider

```typescript
// src/lib/auth/config.ts
export const authConfig = {
  providers: [
    // Existing: Credentials for Super Admin
    Credentials({
      id: "credentials",
      name: "Credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // Super Admin auth logic (existing)
      }
    }),
    
    // NEW: Staff Code Provider
    Credentials({
      id: "staff-code",
      name: "Staff Code",
      credentials: {
        code: { label: "Code", type: "text" }
      },
      async authorize(credentials) {
        if (!credentials?.code) return null;

        const user = await prisma.user.findUnique({
          where: { 
            staffCode: credentials.code,
            role: "STAFF"
          }
        });

        if (!user) return null;
        if (user.status !== "ACTIVE") return null;

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role,
          status: user.status,
          canUpload: user.canUpload,
          canUpdateStatus: user.canUpdateStatus
        };
      }
    })
  ],
  
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.role = user.role;
        token.status = user.status;
        token.canUpload = user.canUpload;
        token.canUpdateStatus = user.canUpdateStatus;
      }
      return token;
    },
    
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;
        session.user.role = token.role as any;
        session.user.status = token.status as any;
        session.user.canUpload = token.canUpload as boolean;
        session.user.canUpdateStatus = token.canUpdateStatus as boolean;
      }
      return session;
    }
  }
};
```

---

## 10. Edge Cases

| ID | Scenario | Expected Behavior | Priority |
|----|----------|-------------------|----------|
| EC-001 | Code exists but wrong role | Return null, show "Invalid code" | Must |
| EC-002 | Code case sensitivity | Case-insensitive match | Must |
| EC-003 | Login mode changes mid-session | User stays logged in, config applies to next login | Should |
| EC-004 | Simultaneous code generation | Retry if duplicate detected | Must |
| EC-005 | User deactivated while logged in | Session remains valid until expiry | Should |

### EC-001: Code Exists but Wrong Role

ğŸ‡»ğŸ‡³
**Khi:** User nháº­p staff code nhÆ°ng user cÃ³ role ADMIN hoáº·c SUPER_ADMIN  
**ThÃ¬:** Auth provider return null (code khÃ´ng tÃ¬m tháº¥y)  
**LÃ½ do:** Staff code chá»‰ dÃ¹ng cho role STAFF

ğŸ‡¬ğŸ‡§
**When:** User enters staff code but user has ADMIN or SUPER_ADMIN role  
**Then:** Auth provider returns null (code not found)  
**Rationale:** Staff codes are only for STAFF role

### EC-002: Code Case Sensitivity

ğŸ‡»ğŸ‡³
**Khi:** User nháº­p "ABC123" nhÆ°ng database lÆ°u "abc123"  
**ThÃ¬:** Normalize code vá» lowercase trÆ°á»›c khi query  
**LÃ½ do:** TrÃ¡nh lá»—i do case mismatch

ğŸ‡¬ğŸ‡§
**When:** User enters "ABC123" but database stores "abc123"  
**Then:** Normalize code to lowercase before query  
**Rationale:** Avoid errors due to case mismatch

### EC-003: Login Mode Changes Mid-Session

ğŸ‡»ğŸ‡³
**Khi:** Admin thay Ä‘á»•i login_mode tá»« "quick_code" sang "full_login" khi staff Ä‘ang login  
**ThÃ¬:** Staff Ä‘ang login khÃ´ng bá»‹ Ä‘Äƒng xuáº¥t, config má»›i chá»‰ Ã¡p dá»¥ng cho láº§n Ä‘Äƒng nháº­p tiáº¿p theo  
**LÃ½ do:** KhÃ´ng giÃ¡n Ä‘oáº¡n workflow hiá»‡n táº¡i

ğŸ‡¬ğŸ‡§
**When:** Admin changes login_mode from "quick_code" to "full_login" while staff is logged in  
**Then:** Logged-in staff are not logged out, new config applies to next login only  
**Rationale:** Don't disrupt current workflow

### EC-004: Simultaneous Code Generation

ğŸ‡»ğŸ‡³
**Khi:** Hai admin táº¡o staff user cÃ¹ng lÃºc, code generator táº¡o ra mÃ£ trÃ¹ng (ráº¥t hiáº¿m)  
**ThÃ¬:** Generator retry láº¡i vá»›i mÃ£ má»›i  
**LÃ½ do:** Äáº£m báº£o uniqueness constraint

ğŸ‡¬ğŸ‡§
**When:** Two admins create staff users simultaneously, code generator produces duplicate (very rare)  
**Then:** Generator retries with new code  
**Rationale:** Ensure uniqueness constraint

### EC-005: User Deactivated While Logged In

ğŸ‡»ğŸ‡³
**Khi:** Admin revoke staff user khi user Ä‘ang login  
**ThÃ¬:** Session váº«n valid Ä‘áº¿n khi háº¿t háº¡n (30 ngÃ y), nhÆ°ng khÃ´ng thá»ƒ renew  
**LÃ½ do:** NextAuth khÃ´ng há»— trá»£ immediate revocation, cáº§n implement token blacklist riÃªng (out of scope)

ğŸ‡¬ğŸ‡§
**When:** Admin revokes staff user while user is logged in  
**Then:** Session remains valid until expiry (30 days), but cannot be renewed  
**Rationale:** NextAuth doesn't support immediate revocation, need separate token blacklist (out of scope)

---

## 11. Error Handling

| Error Condition | User Message (EN/VI) | System Action |
|-----------------|----------------------|---------------|
| Invalid code | "Invalid code. Please check and try again." / "MÃ£ khÃ´ng há»£p lá»‡. Vui lÃ²ng kiá»ƒm tra láº¡i." | Log warning, return 401 |
| Code not found | "Invalid code. Please check and try again." / "MÃ£ khÃ´ng há»£p lá»‡. Vui lÃ²ng kiá»ƒm tra láº¡i." | Log info, return 401 |
| User PENDING | "Account pending approval." / "TÃ i khoáº£n Ä‘ang chá» phÃª duyá»‡t." | Log info, return 403 |
| User REVOKED | "Account deactivated. Contact admin." / "TÃ i khoáº£n bá»‹ vÃ´ hiá»‡u hÃ³a. LiÃªn há»‡ admin." | Log info, return 403 |
| Database error | "Something went wrong. Please try again." / "ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i." | Log error, return 500 |
| Login mode fetch error | "Unable to load login settings." / "KhÃ´ng thá»ƒ táº£i cáº¥u hÃ¬nh Ä‘Äƒng nháº­p." | Log error, fallback to quick_code |

---

## 12. Cross-Root Impact

| Root | Changes | Sync Required |
|------|---------|---------------|
| sgs-cs-helper | Schema, Auth, UI | No (single root) |

### Integration Points

ğŸ‡»ğŸ‡³ ÄÃ¢y lÃ  feature single-root (chá»‰ trong sgs-cs-helper). KhÃ´ng cÃ³ cross-root dependencies. Táº¥t cáº£ thay Ä‘á»•i náº±m trong má»™t workspace root.

ğŸ‡¬ğŸ‡§ This is a single-root feature (only in sgs-cs-helper). No cross-root dependencies. All changes are within one workspace root.

---

## 13. Dependencies

| Dependency | Type | Status | Purpose |
|------------|------|--------|---------|
| `next-auth` | Package | Existing | Authentication framework |
| `@prisma/client` | Package | Existing | Database ORM |
| `crypto` | Node.js built-in | Existing | Random code generation |
| `zod` | Package | Existing | Runtime validation |

---

## 14. Risks & Assumptions

### Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Code collision on generation | Low | Use crypto-safe random with retry logic |
| Users share codes | Medium | Education + audit logs (future) |
| Session hijacking | High | httpOnly cookies + JWT signature |
| Mass code brute-force | Medium | Rate limiting (future enhancement) |

### Assumptions

| # | Assumption | Validated |
|---|------------|-----------|
| 1 | Staff codes are 6-8 chars alphanumeric | Yes (from Phase 0) |
| 2 | Default permissions: canUpload=true, canUpdateStatus=true | Yes |
| 3 | Login mode default is "quick_code" | Yes |
| 4 | NextAuth v5 supports multiple Credentials providers | Yes (verified in docs) |
| 5 | Session expiry is 30 days | Yes (NextAuth default) |

---

## 15. Open Questions

| # | Question | Status | Answer |
|---|----------|--------|--------|
| 1 | Should staff codes expire? | Resolved | No - codes are permanent until admin changes |
| 2 | Should we log failed login attempts? | Resolved | Yes - use NextAuth events (future enhancement) |
| 3 | Should code input be masked? | Resolved | No - codes are meant to be visible for sharing |

---

## 16. Notes

ğŸ‡»ğŸ‡³
- Migration cáº§n cháº¡y TRÆ¯á»šC khi deploy code má»›i (Ä‘á»ƒ thÃªm canUpload, canUpdateStatus)
- Staff code generator utility (cho US-0.2.7) sáº½ Ä‘Æ°á»£c implement trong phase tiáº¿p theo
- Login mode config page (cho US-0.2.8) náº±m ngoÃ i scope cá»§a US-0.2.5

ğŸ‡¬ğŸ‡§
- Migration must run BEFORE deploying new code (to add canUpload, canUpdateStatus)
- Staff code generator utility (for US-0.2.7) will be implemented in next phase
- Login mode config page (for US-0.2.8) is out of scope for US-0.2.5

**Security Note:**
- Staff codes are NOT passwords - they're shared identifiers for quick access
- Real authentication still happens via NextAuth with proper session management
- For sensitive operations, consider requiring full login even for staff

**Performance Note:**
- staffCode index is critical for fast auth lookups
- Consider adding composite index on (staffCode, role, status) if auth queries are slow

---

## Approval

| Role | Name | Status | Date |
|------|------|--------|------|
| Spec Author | GitHub Copilot | âœ… Done | 2026-02-06 |
| Tech Reviewer | ... | â³ Pending | ... |
| Product Owner | ... | â³ Pending | ... |

---

## Next Step

ğŸ‡»ğŸ‡³ Sau khi phÃª duyá»‡t, tiáº¿n hÃ nh **Phase 2: Task Planning**.

ğŸ‡¬ğŸ‡§ After approval, proceed to **Phase 2: Task Planning**.

**Reply:** `approved` or `revise: <feedback>`
